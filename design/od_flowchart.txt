@startuml
start
:Extract target_id, timestamp;

if (Target already initialised?) then (no)
  if (Can initialise with measurement?) then (yes)
    :Initialise state vector + covariance;
  else (no)
    :Return weak prior ODProcessingResult;
    stop
  endif
endif

:Retrieve stored State;
:Compute dt = timestamp - state.time;

:Propagate state (predict step);
:Call _predict(x, P, dt);

:_predict builds augmented state;
:Integrate with crtbp_dstt_dynamics via solve_ivp;
:Extract STM, DSTT;
:Call dstt_pred_mu_p to update covariance;

:Obtain x_pred, P_pred;

:Update with measurement;
:Select measurement model (range / az-el / RA-Dec);
:Compute z_hat, residual, H, R;
:Kalman update (K, x_upd, P_post, NIS, dof);

:Store updated state;
:Return ODProcessingResult;
stop
@enduml