@startuml
actor User
participant "SDEKF" as F
participant "CRTBP Module" as C
participant "STT Module" as T
participant "ConsensusMechanism" as CM

User -> F: process_measurement(measurements)

F -> F: _timestamp_to_seconds()

alt not initialised
  F -> F: _can_initialise()
  alt can initialise
    F -> F: _initialise_state()
  else
    F -> F: _weak_prior_result()
    F --> CM: ODProcessingResult (weak prior)
  end
end

F -> F: _predict_to_time(state, timestamp)
F -> F: _predict(x, P, dt)

F -> C: propagate dynamics\n(STM + DSTT)
C -> C: integrate CRTBP equations,\ncompute tensors
C --> F: propagated state, STM, DSTT

F -> T: dstt_pred_mu_p(P, STM, DSTT, r, dim)
T --> F: updated covariance

F --> F: x_pred, P_pred

F -> F: _update_with_measurement(x_pred, P_pred, meas)
F -> F: _build_measurement_model()

alt range
  F -> F: _build_range_model()
else az/el
  F -> F: _build_azel_model()
else RA/Dec
  F -> F: _build_radec_model()
end

F --> F: residuals, Kalman gain,\nupdated state and covariance

F --> CM: ODProcessingResult (posterior estimate)
@enduml